<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>enjoy page - Games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 폰트 추가 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/HakgyoansimDunggeunmiso/HakgyoansimDunggeunmiso.css" type="text/css"/>
    
    <style>
        @font-face {
            font-family: 'GmarketSansMedium';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'ROKGSans';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/ROKGSansBold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
        }

        body { 
            font-family: 'GmarketSansMedium', sans-serif;
            background-color: #f8f9fa;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-logo { font-family: 'Hakgyoansim Dunggeunmiso', sans-serif; }
        .font-gov { 
            font-family: 'ROKGSans', sans-serif;
            text-shadow: 1px 0 0 currentColor, 0 1px 0 currentColor; 
        }

        .btn-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover:active { transform: scale(0.96); }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden-screen { display: none; }
        .shuffling { color: #005ED2; opacity: 0.7; }
    </style>
</head>
<body class="h-[100dvh] w-full bg-gray-50 overflow-hidden relative">

    <!-- ==================== 관리자 버튼 (우측 상단) ==================== -->
    <div class="absolute top-4 right-4 z-50">
        <button onclick="openAdminLogin()" class="p-2 bg-white rounded-full shadow-md text-gray-400 hover:text-blue-600 transition-colors">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </button>
    </div>

    <!-- ==================== 1. 메인 메뉴 ==================== -->
    <div id="screen-game-menu" class="h-full w-full flex flex-col items-center justify-start p-6 pt-12 bg-gray-50 overflow-y-auto fade-in">
        <div class="w-full max-w-xs flex flex-col gap-6">
            
            <!-- 상단 네비게이션 바 (뒤로가기) -->
            <div class="w-full flex justify-start -mb-4 z-10">
                <button onclick="window.location.href='https://won429.github.io/enjoysite/'" class="p-2 -ml-2 text-gray-400 hover:text-black transition-colors" aria-label="메인으로">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
            </div>

            <!-- 헤더 -->
            <div class="flex items-center justify-center gap-3 mb-2">
                <img src="./image.png" alt="Logo" class="w-10 h-10 object-contain drop-shadow-sm" onerror="this.style.display='none'"> 
                <h2 class="text-2xl font-bold font-logo text-black tracking-tight pt-1">Random enjoy</h2>
            </div>

            <!-- 멤버 리스트 -->
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 mb-2">
                <p class="text-xs text-blue-500 font-bold mb-1">PARTICIPANTS</p>
                <p class="text-sm text-gray-700 leading-relaxed font-medium">
                    전시기, 오스틴, 지노, 홍박사, 성원제 <br>
                    <span class="text-gray-400 text-xs">(총 5명)</span>
                </p>
            </div>

            <!-- 메뉴 버튼들 -->
            <button onclick="switchScreen('screen-car-game');" class="btn-hover w-full bg-white p-6 rounded-2xl shadow-sm border border-gray-200 text-left flex flex-col gap-3 group relative overflow-hidden">
                <div class="absolute right-[-20px] top-[-20px] w-24 h-24 bg-blue-100 rounded-full opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="w-12 h-12 bg-[#005ED2] text-white rounded-xl flex items-center justify-center z-10 shadow-md shadow-blue-200">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                </div>
                <div class="z-10">
                    <h3 class="text-lg font-bold mb-1">차량 & 운전자 뽑기</h3>
                    <p class="text-xs text-gray-500">운전자와 좌석 위치를 랜덤으로 정합니다.</p>
                </div>
            </button>

            <button onclick="switchScreen('screen-chore-game');" class="btn-hover w-full bg-white p-6 rounded-2xl shadow-sm border border-gray-200 text-left flex flex-col gap-3 group relative overflow-hidden">
                <div class="absolute right-[-20px] top-[-20px] w-24 h-24 bg-green-100 rounded-full opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="w-12 h-12 bg-green-500 text-white rounded-xl flex items-center justify-center z-10 shadow-md shadow-green-200">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                </div>
                <div class="z-10">
                    <h3 class="text-lg font-bold mb-1">청소 & 설거지 당번</h3>
                    <p class="text-xs text-gray-500">오늘의 일꾼을 공정하게 뽑아드립니다.</p>
                </div>
            </button>

            <button onclick="switchScreen('screen-trip-game');" class="btn-hover w-full bg-white p-6 rounded-2xl shadow-sm border border-gray-200 text-left flex flex-col gap-3 group relative overflow-hidden">
                <div class="absolute right-[-20px] top-[-20px] w-24 h-24 bg-purple-100 rounded-full opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="w-12 h-12 bg-purple-500 text-white rounded-xl flex items-center justify-center z-10 shadow-md shadow-purple-200">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                </div>
                <div class="z-10">
                    <h3 class="text-lg font-bold mb-1">여행지 뽑기</h3>
                    <p class="text-xs text-gray-500">어디로 떠날까요? 전국 8도 랜덤 추천!</p>
                </div>
            </button>
        </div>
    </div>

    <!-- ==================== 2. 차량 배치 화면 ==================== -->
    <div id="screen-car-game" class="hidden-screen h-full w-full flex-col items-center justify-start p-6 pt-8 bg-white overflow-y-auto">
        <div class="w-full max-w-xs flex flex-col gap-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="switchScreen('screen-game-menu')" class="p-2 -ml-2 text-gray-400 hover:text-black"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                <h2 class="text-lg font-bold">차량 좌석 배치</h2>
                <div class="w-8"></div>
            </div>

            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100 flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-700">운전자 선정 방식</span>
                    <div class="bg-gray-200 p-1 rounded-lg flex text-xs font-bold">
                        <button id="mode-random" onclick="setDriverMode('random')" class="px-3 py-1.5 rounded-md bg-white text-black shadow-sm transition-all">랜덤</button>
                        <button id="mode-manual" onclick="setDriverMode('manual')" class="px-3 py-1.5 rounded-md text-gray-400 transition-all">수동</button>
                    </div>
                </div>
                <div id="manual-selector" class="hidden flex-wrap gap-2 pt-2 border-t border-gray-200"></div>
            </div>

            <div class="relative w-full aspect-[3/4] bg-[#f0f4f8] rounded-[2.5rem] border-4 border-gray-100 p-6 flex flex-col justify-between shadow-inner mt-2">
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-3/4 h-8 bg-gradient-to-b from-blue-100/50 to-transparent rounded-b-3xl"></div>
                <div class="flex gap-4 mb-4">
                    <div class="w-1/2 aspect-square bg-white rounded-2xl border-2 border-[#005ED2] flex flex-col items-center justify-center relative shadow-sm">
                        <span class="absolute top-2 left-2 text-[10px] text-[#005ED2] font-bold bg-blue-50 px-1.5 py-0.5 rounded">DRIVER</span>
                        <div id="seat-driver" class="text-lg font-bold text-black">?</div>
                        <svg class="absolute bottom-2 right-2 text-blue-100 w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                    </div>
                    <div class="w-1/2 aspect-square bg-white rounded-2xl border border-gray-200 flex flex-col items-center justify-center relative shadow-sm">
                        <span class="absolute top-2 left-2 text-[10px] text-gray-400">PASSENGER</span>
                        <div id="seat-p1" class="text-lg font-bold text-gray-800">?</div>
                    </div>
                </div>
                <div class="flex gap-2 h-24">
                    <div class="flex-1 bg-white rounded-xl border border-gray-200 flex items-center justify-center shadow-sm"><div id="seat-b1" class="text-sm font-bold text-gray-800">?</div></div>
                    <div class="flex-1 bg-white rounded-xl border border-gray-200 flex items-center justify-center shadow-sm"><div id="seat-b2" class="text-sm font-bold text-gray-800">?</div></div>
                    <div class="flex-1 bg-white rounded-xl border border-gray-200 flex items-center justify-center shadow-sm"><div id="seat-b3" class="text-sm font-bold text-gray-800">?</div></div>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">BACK SEATS</p>
            </div>

            <button id="btn-run-car" onclick="requestCarGame()" class="w-full bg-[#005ED2] text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform mt-2 text-lg">
                결과 확인하기
            </button>
        </div>
    </div>

    <!-- ==================== 3. 청소 게임 화면 ==================== -->
    <div id="screen-chore-game" class="hidden-screen h-full w-full flex-col items-center justify-start p-6 pt-8 bg-white overflow-y-auto">
        <div class="w-full max-w-xs flex flex-col gap-6">
            <div class="flex items-center justify-between mb-2">
                <button onclick="switchScreen('screen-game-menu')" class="p-2 -ml-2 text-gray-400 hover:text-black"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                <h2 class="text-lg font-bold">당번 뽑기</h2>
                <div class="w-8"></div>
            </div>
            <p class="text-center text-gray-500 text-sm mb-4">오늘의 희생양(?)을 뽑아주세요.</p>

            <div class="w-full bg-blue-50 rounded-2xl p-6 flex items-center justify-between border border-blue-100">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2 text-blue-600 mb-1">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
                        <span class="text-xs font-bold uppercase tracking-wider">Cleaning</span>
                    </div>
                    <span class="text-lg font-bold text-gray-900">청소 당번</span>
                </div>
                <div id="result-cleaning" class="h-12 px-6 bg-white rounded-xl flex items-center justify-center font-bold text-xl text-blue-600 shadow-sm min-w-[100px] transition-colors">?</div>
            </div>

            <div class="w-full bg-green-50 rounded-2xl p-6 flex items-center justify-between border border-green-100">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2 text-green-600 mb-1">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"></path></svg>
                        <span class="text-xs font-bold uppercase tracking-wider">Dishes</span>
                    </div>
                    <span class="text-lg font-bold text-gray-900">설거지 당번</span>
                </div>
                <div id="result-dishes" class="h-12 px-6 bg-white rounded-xl flex items-center justify-center font-bold text-xl text-green-600 shadow-sm min-w-[100px] transition-colors">?</div>
            </div>

            <button id="btn-run-chore" onclick="requestChoreGame()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform mt-8 text-lg">
                추첨 시작하기!
            </button>
        </div>
    </div>

    <!-- ==================== 4. 여행지 게임 화면 ==================== -->
    <div id="screen-trip-game" class="hidden-screen h-full w-full flex-col items-center justify-start p-6 pt-8 bg-white overflow-y-auto">
        <div class="w-full max-w-xs flex flex-col gap-4">
            <div class="flex items-center justify-between mb-2">
                <button onclick="switchScreen('screen-game-menu')" class="p-2 -ml-2 text-gray-400 hover:text-black"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                <h2 class="text-lg font-bold">여행지 뽑기</h2>
                <div class="w-8"></div>
            </div>
            <p class="text-center text-gray-500 text-sm mb-4">2단계 랜덤 추첨 시스템</p>

            <div class="w-full bg-purple-50 rounded-2xl p-4 border-2 border-purple-100 flex flex-col items-center justify-center relative shadow-sm">
                <div class="flex items-center gap-2 mb-2">
                    <span class="w-6 h-6 bg-purple-200 rounded-full flex items-center justify-center text-purple-600 text-xs font-bold">1</span>
                    <span class="text-xs font-bold text-purple-500 uppercase tracking-widest">REGION</span>
                </div>
                <div id="result-trip-step1" class="text-2xl font-bold text-gray-900 break-keep text-center min-h-[2rem]">?</div>
            </div>

            <div class="flex justify-center -my-2 z-10">
                <div class="bg-white p-1 rounded-full border border-gray-100 shadow-sm"><svg class="text-gray-300" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg></div>
            </div>

            <div id="box-trip-step2" class="w-full bg-white rounded-2xl p-4 border-2 border-gray-100 flex flex-col items-center justify-center relative shadow-sm transition-colors duration-300">
                <div class="flex items-center gap-2 mb-2">
                    <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 text-xs font-bold transition-colors" id="badge-step2">2</span>
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest transition-colors" id="label-step2">DETAIL</span>
                </div>
                <div id="result-trip-step2" class="text-2xl font-bold text-gray-300 break-keep text-center min-h-[2rem] transition-colors">-</div>
            </div>

            <button id="btn-run-trip" onclick="requestTripGame()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-purple-200 active:scale-95 transition-transform mt-4 text-lg">
                여행지 확인하기
            </button>
        </div>
    </div>

    <!-- ==================== 관리자 모달 ==================== -->
    <div id="modal-admin-login" class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <h3 class="text-lg font-bold mb-4">관리자 로그인</h3>
            <input type="password" id="admin-pw" class="w-full border border-gray-300 rounded-lg p-3 mb-4 text-center" placeholder="비밀번호 입력">
            <div class="flex gap-2">
                <button onclick="closeAdminLogin()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">취소</button>
                <button onclick="checkAdminPw()" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold text-white">확인</button>
            </div>
        </div>
    </div>

    <div id="modal-admin-panel" class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">관리자 설정</h3>
                <button onclick="closeAdminPanel()" class="text-gray-400"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            
            <div class="space-y-4">
                <!-- 1. 뽑기 제한 초기화 -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-left">
                    <p class="text-sm font-bold text-gray-900 mb-1">뽑기 기회 초기화</p>
                    <p class="text-xs text-gray-500 mb-3">모든 사용자가 다시 1회 뽑을 수 있게 됩니다.</p>
                    <button onclick="adminResetLimits()" class="w-full py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition-colors">
                        모두 초기화 실행
                    </button>
                </div>

                <!-- 2. 무한 모드 토글 -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-left flex items-center justify-between">
                    <div>
                        <p class="text-sm font-bold text-gray-900 mb-1">무한 뽑기 모드</p>
                        <p class="text-xs text-gray-500">1회 제한을 일시적으로 해제합니다.</p>
                    </div>
                    <button id="btn-unlimited-toggle" onclick="adminToggleUnlimited()" class="w-12 h-7 bg-gray-300 rounded-full relative transition-colors">
                        <div class="w-5 h-5 bg-white rounded-full absolute top-1 left-1 transition-transform"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 초기화 (사용자 제공 설정)
        const firebaseConfig = {
            apiKey: "AIzaSyB_GKGcBR-MGnhpRz_UbdRIy_iZN9rjNq4",
            authDomain: "random-enjoy.firebaseapp.com",
            projectId: "random-enjoy",
            storageBucket: "random-enjoy.firebasestorage.app",
            messagingSenderId: "337463244854",
            appId: "1:337463244854:web:9972e90fbacb6869a34097"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Firestore 문서 경로에 사용할 고정 ID (사용자 정의)
        const appId = 'random-enjoy-main'; 

        // 전역 상태
        let globalState = {
            car: { timestamp: 0 },
            chore: { timestamp: 0 },
            trip: { timestamp: 0 },
            admin: { resetTimestamp: 0, unlimited: false }
        };
        let localTimestamps = { car: 0, chore: 0, trip: 0 };
        let isFirstLoad = true; // 첫 로드 여부 체크 (애니메이션 방지)

        let unsubscribe = null;

        // Firestore 리스너 설정
        const setupFirestoreListener = () => {
            const docRef = doc(db, 'games', 'random_enjoy_state');
            
            unsubscribe = onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    handleGameStateChange(data);
                } else {
                    // 초기 데이터가 없으면 생성 (setDoc merge: true)
                    setDoc(docRef, {
                        car: { timestamp: 0 },
                        chore: { timestamp: 0 },
                        trip: { timestamp: 0 },
                        admin: { resetTimestamp: Date.now(), unlimited: false }
                    }, { merge: true }).catch(e => console.error("Error creating init doc:", e));
                }
                isFirstLoad = false; // 첫 스냅샷 처리 후 플래그 해제
            }, (error) => {
                console.error("Snapshot error:", error);
                if(error.code === 'permission-denied') {
                    alert("⚠️ 데이터베이스 권한 오류!\n\nFirebase 콘솔 [Firestore Database > 규칙] 탭에서\nallow read, write: if true; 로 설정해주세요.\n(테스트 모드 권장)");
                }
            });
        };

        // 로그인 및 데이터 구독
        const init = async () => {
            try {
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setupFirestoreListener();
                        updateButtonVisibility(); // 초기 로드 시 버튼 상태 업데이트
                    } else {
                        console.error("Auth failed: No user");
                    }
                });

            } catch (e) {
                console.error("Init error:", e);
            }
        };
        init();

        // 데이터 변경 처리 (애니메이션 트리거)
        function handleGameStateChange(newData) {
            const oldState = globalState;
            globalState = newData;

            // 1. 관리자 설정 변경 감지 (UI 업데이트 등)
            if (newData.admin) {
                updateUnlimitedUI(newData.admin.unlimited);
                updateButtonVisibility(); // 관리자 설정 변경 시 버튼 상태 갱신
            }

            // 2. 각 게임별 업데이트 감지
            // Car Game
            if (newData.car) {
                if (newData.car.timestamp === 0) {
                    window.resetCarGame(); // 초기화 상태면 리셋
                } else if (!isFirstLoad && newData.car.timestamp > localTimestamps.car) {
                    localTimestamps.car = newData.car.timestamp;
                    playCarGameAnimation(newData.car);
                } else {
                    localTimestamps.car = newData.car.timestamp;
                    displayCarResult(newData.car); // 조용히 표시
                }
            }

            // Chore Game
            if (newData.chore) {
                if (newData.chore.timestamp === 0) {
                    window.resetChoreGame();
                } else if (!isFirstLoad && newData.chore.timestamp > localTimestamps.chore) {
                    localTimestamps.chore = newData.chore.timestamp;
                    playChoreGameAnimation(newData.chore);
                } else {
                    localTimestamps.chore = newData.chore.timestamp;
                    displayChoreResult(newData.chore);
                }
            }

            // Trip Game
            if (newData.trip) {
                if (newData.trip.timestamp === 0) {
                    window.resetTripGame();
                } else if (!isFirstLoad && newData.trip.timestamp > localTimestamps.trip) {
                    localTimestamps.trip = newData.trip.timestamp;
                    playTripGameAnimation(newData.trip);
                } else {
                    localTimestamps.trip = newData.trip.timestamp;
                    displayTripResult(newData.trip);
                }
            }
        }

        // 버튼 가리기/보이기 로직 (전역 상태 기반)
        window.updateButtonVisibility = () => {
            const isUnlimited = globalState.admin?.unlimited;
            
            // Car: DB에 결과가 있고(timestamp > 0) 무한모드가 아니면 숨김
            const carHasResult = globalState.car?.timestamp > 0;
            if (!isUnlimited && carHasResult) {
                document.getElementById('btn-run-car').style.display = 'none';
            } else {
                document.getElementById('btn-run-car').style.display = 'block';
            }

            // Chore
            const choreHasResult = globalState.chore?.timestamp > 0;
            if (!isUnlimited && choreHasResult) {
                document.getElementById('btn-run-chore').style.display = 'none';
            } else {
                document.getElementById('btn-run-chore').style.display = 'block';
            }

            // Trip
            const tripHasResult = globalState.trip?.timestamp > 0;
            if (!isUnlimited && tripHasResult) {
                document.getElementById('btn-run-trip').style.display = 'none';
            } else {
                document.getElementById('btn-run-trip').style.display = 'block';
            }
        }

        // ==================== 관리자 기능 ====================
        window.openAdminLogin = () => document.getElementById('modal-admin-login').classList.remove('hidden');
        window.closeAdminLogin = () => document.getElementById('modal-admin-login').classList.add('hidden');
        
        window.checkAdminPw = () => {
            const pw = document.getElementById('admin-pw').value;
            if (pw === '0920') {
                closeAdminLogin();
                document.getElementById('modal-admin-panel').classList.remove('hidden');
                document.getElementById('admin-pw').value = ''; // 비번 초기화
            } else {
                alert('비밀번호가 틀렸습니다.');
            }
        };

        window.closeAdminPanel = () => document.getElementById('modal-admin-panel').classList.add('hidden');

        // 관리자: 리셋 (수정됨: 데이터 전체 덮어쓰기)
        window.adminResetLimits = async () => {
            if (!confirm('모든 사용자의 뽑기 기회를 초기화하시겠습니까?')) return;
            try {
                const docRef = doc(db, 'games', 'random_enjoy_state'); 
                
                // 안전한 업데이트: 현재 admin state를 가져와서 timestamp만 갱신하고 나머지는 초기화
                const currentAdminState = globalState.admin || { unlimited: false };
                
                // setDoc 없이 전체 덮어쓰기 (merge: false와 동일한 효과를 내기 위해 필드 명시)
                // car, chore, trip을 초기 상태(timestamp: 0)로 리셋
                await setDoc(docRef, {
                    car: { timestamp: 0 },
                    chore: { timestamp: 0 },
                    trip: { timestamp: 0 },
                    admin: { 
                        ...currentAdminState, 
                        resetTimestamp: Date.now() 
                    }
                });
                
                alert('✅ 초기화가 완료되었습니다! 모든 사용자가 다시 뽑을 수 있습니다.');
            } catch (e) {
                console.error("Reset failed:", e);
                alert("초기화 실패: " + e.message);
            }
        };

        // 관리자: 무한 모드 토글
        window.adminToggleUnlimited = async () => {
            try {
                const current = globalState.admin?.unlimited || false;
                const docRef = doc(db, 'games', 'random_enjoy_state');
                
                // 안전한 업데이트
                const currentAdminState = globalState.admin || { resetTimestamp: 0 };

                await setDoc(docRef, {
                    admin: {
                        ...currentAdminState,
                        unlimited: !current
                    }
                }, { merge: true });
            } catch (e) {
                console.error("Toggle unlimited failed:", e);
                alert("설정 변경 실패: " + e.message);
            }
        };

        function updateUnlimitedUI(isUnlimited) {
            const btn = document.getElementById('btn-unlimited-toggle');
            const dot = btn.querySelector('div');
            if (isUnlimited) {
                btn.classList.replace('bg-gray-300', 'bg-green-500');
                dot.classList.replace('left-1', 'translate-x-5'); // 이동
                dot.style.transform = 'translateX(20px)'; // tailwind translate class bug fix
            } else {
                btn.classList.replace('bg-green-500', 'bg-gray-300');
                dot.classList.replace('translate-x-5', 'left-1');
                dot.style.transform = 'translateX(0)';
            }
        }

        // ==================== 게임 요청 로직 (Client -> DB) ====================
        
        // 공통: 실행 가능 여부 체크 (로컬스토리지 방식 폐기, 글로벌 상태로 체크)
        function canPlay(gameType) {
            if (globalState.admin?.unlimited) return true; 
            if (globalState[gameType]?.timestamp > 0) {
                alert('이미 결과가 나와있습니다! (관리자가 초기화해야 다시 가능)');
                return false;
            }
            return true;
        }

        // 1. 차량 게임 요청
        window.requestCarGame = async () => {
            if (!canPlay('car')) return;
            
            const driverMode = window.getDriverMode(); 
            const selectedDriver = window.getSelectedDriver();
            
            if (driverMode === 'manual' && !selectedDriver) {
                alert('운전자를 선택해주세요!');
                return;
            }

            let finalDriver = '';
            let passengers = [];
            if (driverMode === 'manual') {
                finalDriver = selectedDriver;
                passengers = MEMBERS.filter(m => m !== finalDriver);
            } else {
                const shuffled = [...MEMBERS].sort(() => Math.random() - 0.5);
                finalDriver = shuffled[0];
                passengers = shuffled.slice(1);
            }
            const shuffledPassengers = passengers.sort(() => Math.random() - 0.5);

            const docRef = doc(db, 'games', 'random_enjoy_state');
            // setDoc with merge: true to safely update/create
            // Note: Overwriting the SAME document keeps storage size constant (~1KB)
            await setDoc(docRef, {
                car: {
                    driver: finalDriver,
                    passengers: shuffledPassengers,
                    timestamp: Date.now()
                }
            }, { merge: true });
        };

        // 2. 청소 게임 요청
        window.requestChoreGame = async () => {
            if (!canPlay('chore')) return;

            const shuffled = [...MEMBERS].sort(() => Math.random() - 0.5);
            const docRef = doc(db, 'games', 'random_enjoy_state');
            await setDoc(docRef, {
                chore: {
                    cleaner: shuffled[0],
                    dishwasher: shuffled[1],
                    timestamp: Date.now()
                }
            }, { merge: true });
        };

        // 3. 여행 게임 요청
        window.requestTripGame = async () => {
            if (!canPlay('trip')) return;

            const step1 = REGION_POOL[Math.floor(Math.random() * REGION_POOL.length)];
            let step2 = null;
            
            if (TRIP_REGIONS_COMPLEX[step1]) {
                const subs = TRIP_REGIONS_COMPLEX[step1];
                step2 = subs[Math.floor(Math.random() * subs.length)];
            }

            const docRef = doc(db, 'games', 'random_enjoy_state');
            await setDoc(docRef, {
                trip: {
                    step1: step1,
                    step2: step2,
                    timestamp: Date.now()
                }
            }, { merge: true });
        };


        // ==================== 애니메이션 및 표시 로직 ====================
        
        // 차량 게임
        function playCarGameAnimation(data) {
            window.initAudio();
            // 애니메이션
            const driverEl = document.getElementById('seat-driver');
            const pEls = ['seat-p1', 'seat-b1', 'seat-b2', 'seat-b3'].map(id => document.getElementById(id));
            
            // 운전자는 랜덤 셔플 애니메이션 (수동모드였어도 보는 사람 입장에선 결과가 짠하고 나오는게 좋음)
            window.animateShuffle(driverEl, MEMBERS, data.driver, 2000);
            
            pEls.forEach((el, i) => {
                window.animateShuffle(el, MEMBERS, data.passengers[i], 2000 + (i * 400));
            });
        }
        function displayCarResult(data) {
            if(!data.driver) return;
            document.getElementById('seat-driver').textContent = data.driver;
            document.getElementById('seat-driver').style.color = "#005ED2"; // 파랑
            const pIds = ['seat-p1', 'seat-b1', 'seat-b2', 'seat-b3'];
            pIds.forEach((id, i) => {
                const el = document.getElementById(id);
                el.textContent = data.passengers[i];
                el.style.color = "#005ED2";
            });
        }

        // 청소 게임
        function playChoreGameAnimation(data) {
            window.initAudio();
            const cEl = document.getElementById('result-cleaning');
            const dEl = document.getElementById('result-dishes');
            window.animateShuffle(cEl, MEMBERS, data.cleaner, 1500);
            window.animateShuffle(dEl, MEMBERS, data.dishwasher, 2500);
        }
        function displayChoreResult(data) {
            if(!data.cleaner) return;
            const cEl = document.getElementById('result-cleaning');
            const dEl = document.getElementById('result-dishes');
            cEl.textContent = data.cleaner;
            dEl.textContent = data.dishwasher;
            cEl.style.color = "#2563eb";
            dEl.style.color = "#16a34a";
        }

        // 여행 게임
        function playTripGameAnimation(data) {
            window.initAudio();
            window.resetTripUI();
            
            const el1 = document.getElementById('result-trip-step1');
            const el2 = document.getElementById('result-trip-step2');

            window.animateShuffleCallback(el1, REGION_POOL, data.step1, 2000, () => {
                if (data.step2) {
                    setTimeout(() => {
                        window.activateStep2UI();
                        // 2단계 셔플 (후보군: 해당 지역의 하위 지역)
                        const subRegions = TRIP_REGIONS_COMPLEX[data.step1];
                        window.animateShuffleCallback(el2, subRegions, data.step2, 2000, () => {
                            window.playWinSound();
                        });
                    }, 300);
                } else {
                    el2.textContent = "해당 없음";
                    window.playWinSound();
                }
            });
        }
        function displayTripResult(data) {
            if(!data.step1) return;
            window.resetTripUI();
            document.getElementById('result-trip-step1').textContent = data.step1;
            document.getElementById('result-trip-step1').style.color = "#9333ea";
            
            if (data.step2) {
                window.activateStep2UI();
                const el2 = document.getElementById('result-trip-step2');
                el2.textContent = data.step2;
                el2.style.color = "#9333ea";
            } else {
                document.getElementById('result-trip-step2').textContent = "해당 없음";
            }
        }

    </script>

    <!-- 기존 로직 스크립트 (UI Helper 및 사운드) -->
    <script>
        const MEMBERS = ['전시기', '오스틴', '지노', '홍박사', '성원제'];
        const TRIP_REGIONS_SIMPLE = ['서울특별시', '대전광역시', '대구광역시', '부산광역시', '인천광역시', '광주광역시', '세종특별자치시'];
        const TRIP_REGIONS_COMPLEX = {
            '경기도': ['수원시', '고양시', '용인시', '성남시', '부천시', '화성시', '안산시', '남양주시', '안양시', '평택시', '시흥시', '파주시', '의정부시', '김포시', '광주시', '광명시', '군포시', '하남시', '오산시', '양주시', '이천시', '구리시', '안성시', '포천시', '의왕시', '양평군', '여주시', '동두천시', '가평군', '과천시', '연천군'],
            '강원특별자치도': ['춘천시', '원주시', '강릉시', '동해시', '태백시', '속초시', '삼척시', '홍천군', '횡성군', '영월군', '평창군', '정선군', '철원군', '화천군', '양구군', '인제군', '고성군', '양양군'],
            '충청북도': ['청주시', '충주시', '제천시', '보은군', '옥천군', '영동군', '증평군', '진천군', '괴산군', '음성군', '단양군'],
            '충청남도': ['천안시', '공주시', '보령시', '아산시', '서산시', '논산시', '계룡시', '당진시', '금산군', '부여군', '서천군', '청양군', '홍성군', '예산군', '태안군'],
            '전북특별자치도': ['전주시', '군산시', '익산시', '정읍시', '남원시', '김제시', '완주군', '진안군', '무주군', '장수군', '임실군', '순창군', '고창군', '부안군'],
            '전라남도': ['목포시', '여수시', '순천시', '나주시', '광양시', '담양군', '곡성군', '구례군', '고흥군', '보성군', '화순군', '장흥군', '강진군', '해남군', '영암군', '무안군', '함평군', '영광군', '장성군', '완도군', '진도군', '신안군'],
            '경상북도': ['포항시', '경주시', '김천시', '안동시', '구미시', '영주시', '영천시', '상주시', '문경시', '경산시', '군위군', '의성군', '청송군', '영양군', '영덕군', '청도군', '고령군', '성주군', '칠곡군', '예천군', '봉화군', '울진군', '울릉군'],
            '경상남도': ['창원시', '진주시', '통영시', '사천시', '김해시', '밀양시', '거제시', '양산시', '의령군', '함안군', '창녕군', '고성군', '남해군', '하동군', '산청군', '함양군', '거창군', '합천군'],
            '제주특별자치도': ['제주시', '서귀포시']
        };
        const REGION_POOL = [...TRIP_REGIONS_SIMPLE, ...Object.keys(TRIP_REGIONS_COMPLEX)];

        // UI Helpers
        function switchScreen(screenId) {
            document.querySelectorAll('[id^="screen-"]').forEach(el => {
                el.classList.add('hidden-screen');
                el.classList.remove('flex', 'fade-in');
            });
            const target = document.getElementById(screenId);
            target.classList.remove('hidden-screen');
            target.classList.add('flex', 'fade-in');
        }

        // 차량 게임 UI Helper
        let driverMode = 'random';
        let selectedDriver = null;
        
        window.getDriverMode = () => driverMode;
        window.getSelectedDriver = () => selectedDriver;

        window.resetCarGame = () => {
            window.setDriverMode('random');
            clearCarResults();
        }
        window.setDriverMode = (mode) => {
            driverMode = mode;
            selectedDriver = null;
            const btnRandom = document.getElementById('mode-random');
            const btnManual = document.getElementById('mode-manual');
            const selector = document.getElementById('manual-selector');
            const driverSeat = document.getElementById('seat-driver');

            if (mode === 'random') {
                btnRandom.classList.replace('text-gray-400', 'bg-white');
                btnRandom.classList.add('text-black', 'shadow-sm');
                btnManual.classList.remove('bg-white', 'text-black', 'shadow-sm');
                btnManual.classList.add('text-gray-400');
                selector.classList.add('hidden');
                selector.classList.remove('flex');
                
                // 기존 결과가 '선택필요'일 때만 '?'로 리셋
                if(driverSeat.textContent === '선택필요') {
                    driverSeat.textContent = '?';
                    driverSeat.style.color = '';
                }
            } else {
                btnManual.classList.replace('text-gray-400', 'bg-white');
                btnManual.classList.add('text-black', 'shadow-sm');
                btnRandom.classList.remove('bg-white', 'text-black', 'shadow-sm');
                btnRandom.classList.add('text-gray-400');
                selector.classList.remove('hidden');
                selector.classList.add('flex');
                renderManualSelector();
                
                // 기존 결과가 없거나 '?'일 때만 '선택필요'로 변경
                if(driverSeat.textContent === '?' || driverSeat.textContent === '...') {
                    driverSeat.textContent = '선택필요';
                    driverSeat.style.color = 'gray';
                }
            }
            // clearCarResults(); // 삭제됨: 모드 변경 시 결과 유지
        }
        function renderManualSelector() {
            const container = document.getElementById('manual-selector');
            container.innerHTML = '<p class="w-full text-xs text-gray-400 mb-1">운전할 사람을 먼저 선택하세요:</p>';
            MEMBERS.forEach(member => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1 text-sm rounded-full border transition-all ${selectedDriver === member ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300'}`;
                btn.textContent = member;
                btn.onclick = () => {
                    selectedDriver = member;
                    document.getElementById('seat-driver').textContent = member;
                    document.getElementById('seat-driver').style.color = '#005ED2'; // 선택 시 파란색
                    renderManualSelector();
                };
                container.appendChild(btn);
            });
        }
        function clearCarResults() {
            const seats = ['seat-driver', 'seat-p1', 'seat-b1', 'seat-b2', 'seat-b3'];
            seats.forEach(id => {
                const el = document.getElementById(id);
                el.textContent = '?';
                el.style.color = ''; 
                el.classList.remove('shuffling', 'text-red-500', 'text-blue-600'); 
                el.classList.add('text-black', 'text-gray-800');
            });
            if(driverMode === 'manual' && !selectedDriver) {
                document.getElementById('seat-driver').textContent = '선택필요';
                document.getElementById('seat-driver').style.color = 'gray';
            }
        }

        // 청소 게임 UI Helper (Uncommented and fixed)
        window.resetChoreGame = () => {
            document.getElementById('result-cleaning').textContent = '?';
            document.getElementById('result-dishes').textContent = '?';
            document.getElementById('result-cleaning').style.color = '';
            document.getElementById('result-dishes').style.color = '';
        }

        // 여행 게임 UI Helper (Uncommented and fixed)
        window.resetTripGame = () => {
            resetTripUI();
        }
        window.resetTripUI = () => {
            document.getElementById('result-trip-step1').textContent = '?';
            document.getElementById('result-trip-step2').textContent = '-';
            
            const box2 = document.getElementById('box-trip-step2');
            const text2 = document.getElementById('result-trip-step2');
            const badge2 = document.getElementById('badge-step2');
            const label2 = document.getElementById('label-step2');
            
            box2.classList.replace('border-purple-100', 'border-gray-100');
            box2.classList.replace('bg-purple-50', 'bg-white');
            text2.classList.replace('text-gray-900', 'text-gray-300');
            badge2.classList.replace('bg-purple-200', 'bg-gray-100');
            badge2.classList.replace('text-purple-600', 'text-gray-400');
            label2.classList.replace('text-purple-500', 'text-gray-400');
            
            document.getElementById('result-trip-step1').classList.remove('shuffling', 'text-purple-600');
            text2.classList.remove('shuffling', 'text-purple-600');
            document.getElementById('result-trip-step1').style.color = '';
            text2.style.color = '';
        }
        window.activateStep2UI = () => {
            const box2 = document.getElementById('box-trip-step2');
            const text2 = document.getElementById('result-trip-step2');
            const badge2 = document.getElementById('badge-step2');
            const label2 = document.getElementById('label-step2');
            
            box2.classList.replace('border-gray-100', 'border-purple-100');
            box2.classList.replace('bg-white', 'bg-purple-50');
            text2.classList.replace('text-gray-300', 'text-gray-900');
            badge2.classList.replace('bg-gray-100', 'bg-purple-200');
            badge2.classList.replace('text-gray-400', 'text-purple-600');
            label2.classList.replace('text-gray-400', 'text-purple-500');
        }

        // 사운드
        let audioCtx = null;
        window.initAudio = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        window.playWinSound = () => {
            window.initAudio();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(659, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(3.0, audioCtx.currentTime); 
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.4);
        }
        window.playTickSound = () => {
            window.initAudio();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(1.0, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.05);
        }

        // 공통 애니메이션
        window.animateShuffle = (element, candidates, finalValue, duration) => {
            window.animateShuffleCallback(element, candidates, finalValue, duration, null);
        }
        window.animateShuffleCallback = (element, candidates, finalValue, duration, callback) => {
            element.classList.add('shuffling');
            let tickCount = 0;
            const interval = setInterval(() => {
                const randomVal = candidates[Math.floor(Math.random() * candidates.length)];
                element.textContent = randomVal;
                tickCount++;
                if(tickCount % 3 === 0) window.playTickSound(); 
            }, 80); 

            setTimeout(() => {
                clearInterval(interval);
                element.textContent = finalValue;
                element.classList.remove('shuffling');
                
                if (!callback) {
                    window.playWinSound();
                    element.style.transform = "scale(1.2)";
                    if(element.id.includes('cleaning')) element.style.color = "#2563eb"; 
                    else if(element.id.includes('dishes')) element.style.color = "#16a34a"; 
                    else if(element.id.includes('seat')) element.style.color = "#005ED2"; 
                    else if(element.id.includes('trip')) element.style.color = "#9333ea";
                    setTimeout(() => { element.style.transform = "scale(1)"; }, 300);
                } else {
                    callback();
                    if(element.id.includes('trip')) {
                        element.style.transform = "scale(1.1)";
                        element.style.color = "#9333ea";
                        setTimeout(() => { element.style.transform = "scale(1)"; }, 300);
                    }
                }
            }, duration);
        }
    </script>
</body>
</html>